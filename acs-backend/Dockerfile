# ç¬¬ 1 éšæ®µï¼ˆbuildï¼‰
# å»ºæ§‹åŸå§‹ç¢¼ã€æ‰“åŒ… .jar æª”æ¡ˆï¼ˆåŒ…å« commom moduleï¼‰
FROM eclipse-temurin:21-jdk-alpine AS build
# ä½¿ç”¨ Temurin JDK 21 + Alpine ç‰ˆæœ¬ ä½œç‚ºã€Œå»ºæ§‹éšæ®µï¼ˆbuild stageï¼‰ã€çš„åŸºç¤ image
# AS build æ˜¯çµ¦é€™å€‹éšæ®µä¸€å€‹åå­—ï¼Œè®“å¾Œé¢å¯ä»¥å¼•ç”¨
# alpine è¡¨ç¤ºæ˜¯è¼•é‡ç‰ˆ Linuxï¼Œimage å°ã€æ•ˆç‡é«˜ï¼Œä½†é è¨­å·¥å…·è¼ƒå°‘

WORKDIR /usr/src/app
# è¨­å®šå·¥ä½œç›®éŒ„ç‚º /usr/src/appï¼Œä¹‹å¾Œæ‰€æœ‰æ“ä½œï¼ˆå¦‚ COPYã€RUNï¼‰éƒ½æœƒåœ¨é€™å€‹ç›®éŒ„ä¸‹é€²è¡Œ
# æ²’æœ‰é€™å€‹ç›®éŒ„æ™‚æœƒè‡ªå‹•å»ºç«‹
# /usr/src/app æ˜¯é–‹æºå°ˆæ¡ˆæ…£ä¾‹ï¼šsource code æš«å­˜èˆ‡ç·¨è­¯å€

## è¤‡è£½ Maven Wrapper æ‰€éœ€æª”æ¡ˆ
COPY mvnw mvnw
COPY .mvn .mvn

# è¤‡è£½æ•´å€‹ multi-module å°ˆæ¡ˆï¼ˆåŒ…å« backend å’Œ commonï¼‰
COPY acs-common acs-common
COPY acs-backend acs-backend
COPY pom.xml pom.xml

##  çµ¦ Maven Wrapper åŸ·è¡Œæ¬Šé™
RUN chmod +x mvnw

RUN echo "ğŸ‘€ åˆ—å‡ºç›®å‰ç›®éŒ„å…§å®¹ï¼š" && ls -al /usr/src/app

# å»ºç½® backend module  ä½¿ç”¨ Maven Wrapper æŒ‡å®šåªæ‰“åŒ… backend æ¨¡çµ„ï¼ˆè·³éæ¸¬è©¦ï¼‰è‡ªå‹•å…ˆå»º acs-commonã€å†å»º acs-backend
RUN ./mvnw -pl acs-backend -am clean package -DskipTests

# build éšæ®µæ‰¾å‡ºæ­£ç¢º jar åç¨±ï¼Œæ”¹åæˆæ¨™æº–åç¨± app.jar
RUN cp acs-backend/target/*.jar app.jar

# ç¬¬ 2 éšæ®µï¼ˆrunï¼‰
# è¼‰å…¥ .jarï¼Œä¹¾æ·¨åŸ·è¡Œï¼Œä¸å«å¤šé¤˜æª”æ¡ˆæˆ–å·¥å…·
FROM eclipse-temurin:21-jdk-alpine
# ç¬¬äºŒéšæ®µï¼šåªç”¨ä¸€å€‹ã€Œä¹¾æ·¨çš„ JDK åŸ·è¡Œç’°å¢ƒã€ï¼Œä¸åŒ…å« Mavenã€åŸå§‹ç¢¼ç­‰å…§å®¹
# é€™æœƒå¤§å¹…ç¸®å° image ä¸¦æå‡å®‰å…¨æ€§

WORKDIR /app
# è¨­å®šåŸ·è¡Œéšæ®µçš„å·¥ä½œç›®éŒ„ç‚º /app

# è¤‡è£½æ‰“åŒ…å¾Œçš„ JAR
COPY --from=build /usr/src/app/app.jar app.jar
# å¾å‰ä¸€å€‹éšæ®µï¼ˆåç‚º buildï¼‰è¤‡è£½å‡ºæ‰“åŒ…å¥½çš„ JAR æª”ï¼Œæ”¾åˆ° /app ä¸¦é‡æ–°å‘½åç‚º app.jar

EXPOSE 8080
#å®£å‘Šé€™å€‹ container æœƒå°å¤–é–‹æ”¾çš„ port æ˜¯ 8080

CMD ["java", "-jar", "app.jar"]
#è¨­å®š container çš„é è¨­å•Ÿå‹•æŒ‡ä»¤ï¼Œcontainer å•Ÿå‹•æ™‚æœƒåŸ·è¡Œé€™ä¸€è¡Œï¼ŒåŸ·è¡Œ JAR æª”
# modified test