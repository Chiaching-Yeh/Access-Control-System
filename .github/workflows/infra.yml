name: Deploy infra

on:
  workflow_dispatch:

jobs:
  deploy-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Clean Docker Build Cache In Runner
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af
          docker builder prune -af
          echo "Docker resources cleaned."

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: SSH to VM via gcloud and deploy infra
        env:
          VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_REDIS_HOST: ${{ secrets.SPRING_REDIS_HOST }}
          MQTT_BROKER: ${{ secrets.MQTT_BROKER }}
          MQTT_CLIENT_ID: ${{ secrets.MQTT_CLIENT_ID }}
          MQTT_USERNAME: ${{ secrets.MQTT_USERNAME }}
          MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
          MQTT_HOST: ${{ secrets.MQTT_HOST }}
          MQTT_PORT: ${{ secrets.MQTT_PORT }}
          TZ: ${{ secrets.TZ }}
        run: |
          echo "ğŸ” å°‡ç§é‘°å¯«å…¥ SSH é‡‘é‘°æª”"
          mkdir -p ~/.ssh
          echo "$VM_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          echo "ğŸ” åŠ å…¥ VM åˆ° known_hostsï¼ˆé¿å…é¦–æ¬¡é€£ç·šæç¤ºï¼‰"
          ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
          
          echo "ğŸ›  ä¿®æ­£ mqtt æ¬Šé™ä¸­..."
          sudo chown -R $(whoami):$(whoami) ./mqtt
          
          echo "ğŸ” é–‹å§‹ç™»å…¥ä¸¦åŸ·è¡Œéƒ¨ç½²è…³æœ¬"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << EOF
          
            set -e 
          
            echo 'ğŸ” [1/5] ç¢ºèª Access-Control-System æ˜¯å¦å­˜åœ¨'
            if [ -d ~/Access-Control-System/.git ]; then
              echo 'ğŸ“¦ å·²å­˜åœ¨ Git å°ˆæ¡ˆï¼ŒåŸ·è¡Œ git pull'
              cd ~/Access-Control-System
              git pull origin main
            else
              echo 'ğŸ” [å‰ç½®] åŠ å…¥ GitHub åˆ° VM çš„ known_hostsï¼ˆé¿å… host key verification failedï¼‰'
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              echo 'ğŸ†• å°ˆæ¡ˆä¸å­˜åœ¨ï¼ŒåŸ·è¡Œ git clone'
              git clone git@github.com:Chiaching-Yeh/Access-Control-System.git ~/Access-Control-System
            fi

            echo 'ğŸ” [2/5] åˆ‡æ›è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ ~/Access-Control-System'
            cd ~/Access-Control-System && pwd && ls -la
          
            echo "ğŸ”‘ [3/5] ç”¢ç”Ÿ .env æª”æ¡ˆ"
            echo "POSTGRES_DB=$POSTGRES_DB" > .env
            echo "POSTGRES_USER=$POSTGRES_USER" >> .env
            echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
          
            echo "SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL" >> .env
            echo "SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD" >> .env
            echo "SPRING_REDIS_HOST=$SPRING_REDIS_HOST" >> .env
          
            echo "MQTT_BROKER=$MQTT_BROKER" >> .env
            echo "MQTT_CLIENT_ID=$MQTT_CLIENT_ID" >> .env
            echo "MQTT_USERNAME=$MQTT_USERNAME" >> .env
            echo "MQTT_PASSWORD=$MQTT_PASSWORD" >> .env
          
            echo "DOCKER_REGISTRY=$DOCKER_REGISTRY" >> .env
          
            echo "MQTT_HOST=$MQTT_HOST" >> .env
            echo "MQTT_PORT=$MQTT_PORT" >> .env
            echo "TZ=$TZ" >> .env
          
            echo "ğŸ” [4/5] ç¢ºèª .env èˆ‡å®¹å™¨ç’°å¢ƒè®Šæ•¸ä¸€è‡´"
            if grep -q "$POSTGRES_DB" .env && grep -q "$MQTT_CLIENT_ID" .env; then
              echo "âœ… .env ä¸­åŒ…å«æ©Ÿå¯†è®Šæ•¸ï¼Œæ‡‰ç‚ºéƒ¨ç½²æ™‚è‡ªå‹•ç”¢ç”Ÿ"
            else
              echo "âŒ .env å…§å®¹ç•°å¸¸ï¼Œæ©Ÿå¯†è®Šæ•¸ç¼ºå¤±ï¼Œè«‹ç¢ºèª CI/CD æ˜¯å¦æ³¨å…¥å¤±æ•—"
              exit 1
            fi
          
            echo 'ğŸ” [5/5] åŸ·è¡Œ docker compose up'
            if [ "$(docker inspect -f '{{.State.Running}}' acs-db 2>/dev/null)" != "true" ] || \
               [ "$(docker inspect -f '{{.State.Running}}' acs-redis 2>/dev/null)" != "true" ] || \
               [ "$(docker inspect -f '{{.State.Running}}' acs-mqtt 2>/dev/null)" != "true" ]; then
              echo 'ğŸ”§ æœ‰ Infra container æœªåŸ·è¡Œï¼Œé‡æ–°å•Ÿå‹• Infra...'
              docker compose -p access-control-system -f docker-compose-infra.yml up -d
              echo 'âœ… Infra å•Ÿå‹•å®Œæˆ'
              echo "$(date)" > /tmp/infra_ready
            else
              echo "âœ… æ‰€æœ‰ Infra container å·²åœ¨åŸ·è¡Œ"
            fi
          
          EOF
