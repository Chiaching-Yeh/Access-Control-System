name: Deploy simulator

on:
  workflow_dispatch:
  push:
    paths:
      - 'simulator/**'  # åªè¦ simulator è³‡æ–™å¤¾æœ‰è®Šæ›´ï¼Œå°±è§¸ç™¼é€™å€‹ workflow #test
      - '.github/workflows/simulator.yml'   # æˆ–è€…é€™å€‹ workflow æª”æ¡ˆæœ¬èº«æœ‰è®Šæ›´
    branches: [main] # é™å®š main åˆ†æ”¯

permissions:  # è®“ GITHUB_TOKEN æœ‰æ¬Šé™å‘¼å« workflow_dispatch
  contents: read
  actions: write

jobs:
  trigger-infra:
    name: "Ensure Infra Ready"
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Infra Deployment
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: infra.yml
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy-simulator:
    runs-on: ubuntu-latest # åœ¨ GitHub æä¾›çš„ Ubuntu runner ä¸ŠåŸ·è¡Œ

    steps:
      - name: Checkout source
        uses: actions/checkout@v4 # æŠŠ GitHub Repo çš„ç¨‹å¼ç¢¼æŠ“ä¸‹ä¾†åˆ° runner ä¸Š

      - name: Clean Docker Build Cache In Runner
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af
          docker builder prune -af
          echo "Docker resources cleaned."

      - name: Authenticate with Google Cloud # è¨­å®š GCP å°ˆæ¡ˆ IDï¼ˆä¾†è‡ª GitHub Secretï¼‰
        uses: google-github-actions/auth@v2 # ä½¿ç”¨ GCP æœå‹™å¸³è™Ÿé‡‘é‘°ç™»å…¥ï¼ˆJSONï¼‰
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use Artifact Registry
        env:
          REGION: ${{ secrets.REGION }}
        run: gcloud auth configure-docker $REGION-docker.pkg.dev # è¨­å®š Docker å¯ä»¥ç™»å…¥ GCP çš„ Artifact Registryï¼Œç”¨ä¾†æ¨é€ image

      - name: Build and Push Simulator Docker Image
        run: |
          echo "Deploying commit SHA: ${{ github.sha }}"
          IMAGE_TAG=${{ github.sha }}
          docker build \
            --no-cache \
            -t ${{ secrets.DOCKER_REGISTRY }}/acs-simulator:$IMAGE_TAG \
            -f ./simulator/Dockerfile \
            ./simulator
          docker push ${{ secrets.DOCKER_REGISTRY }}/acs-simulator:$IMAGE_TAG
          echo "ğŸ” Listing pushed image:"
          docker images | grep acs-simulator

      - name: SSH to VM via gcloud and deploy simulator
        env:
          VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
          IMAGE_TAG: ${{ github.sha }}
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
        run: |
          echo "ğŸ” å°‡ç§é‘°å¯«å…¥ SSH é‡‘é‘°æª”"
          mkdir -p ~/.ssh
          echo "$VM_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          echo "ğŸ” åŠ å…¥ VM åˆ° known_hostsï¼ˆé¿å…é¦–æ¬¡é€£ç·šæç¤ºï¼‰"
          ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
          
          echo "ğŸ§ª DOCKER_REGISTRY=$DOCKER_REGISTRY"
          echo "ğŸ§ª IMAGE_TAG=$IMAGE_TAG"
          echo "ğŸ§ª pull target = $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG"
          
          echo "ğŸ” é–‹å§‹ç™»å…¥ä¸¦åŸ·è¡Œéƒ¨ç½²è…³æœ¬"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << EOF
          
            set -e 
          
            echo 'ğŸ” [0/6] æ¸…é™¤ VM ä¸Š Docker å¿«å–'
            docker system prune -af
            docker builder prune -af

            echo 'ğŸ” [1/6] è¨­å®š IMAGE_TAGã€DOCKER_REGISTRY ç’°å¢ƒè®Šæ•¸'
            export IMAGE_TAG=$IMAGE_TAG
            export DOCKER_REGISTRY=$DOCKER_REGISTRY
          
            echo 'ğŸ” [2/6] ç¢ºèª Access-Control-System æ˜¯å¦å­˜åœ¨'
            if [ -d ~/Access-Control-System/.git ]; then
              echo 'ğŸ“¦ å·²å­˜åœ¨ Git å°ˆæ¡ˆï¼ŒåŸ·è¡Œ git pull'
              cd ~/Access-Control-System && git pull origin main
            else
              echo 'ğŸ†• å°ˆæ¡ˆä¸å­˜åœ¨ï¼ŒåŸ·è¡Œ git clone'
              git clone git@github.com:Chiaching-Yeh/Access-Control-System.git ~/Access-Control-System
            fi

            echo 'ğŸ” [3/6] åˆ‡æ›è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ ~/Access-Control-System'
            cd ~/Access-Control-System && pwd && ls -la
               
            echo 'ğŸ” [4/6] æª¢æŸ¥ infra container æ˜¯å¦å•Ÿå‹•'
            if ! docker ps --format '{{.Names}}' | grep -q 'acs-db' || \
               ! docker ps --format '{{.Names}}' | grep -q 'acs-redis' || \
               ! docker ps --format '{{.Names}}' | grep -q 'acs-mqtt'; then
              echo 'ğŸ”§ æœ‰ infra container æ²’æœ‰å•Ÿå‹•ï¼ŒåŸ·è¡Œ docker compose up for infra'
              docker compose -f infra.yml up -d
            else
              echo 'âœ… æ‰€æœ‰ infra container å·²åœ¨åŸ·è¡Œ'
            fi   
          
            echo "ğŸ” [5/6] å˜—è©¦æ‹‰å–æ˜ åƒ $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG"
            docker pull $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG
          
            echo "ğŸ” é©—è­‰æ˜ åƒå·²å­˜åœ¨æ–¼æœ¬åœ°"
            docker image inspect $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG >/dev/null && \
            echo "âœ… æ˜ åƒç¢ºèªæˆåŠŸå­˜åœ¨" || echo "âŒ æ‹‰å–å¤±æ•—"

            echo 'ğŸ” [6/6] åŸ·è¡Œ docker compose up -d simulator'
            docker compose up -d simulator

            echo 'âœ… éƒ¨ç½²å®Œæˆ'
          EOF