name: Deploy simulator

on:
  workflow_dispatch:
  push:
    paths:
      - 'simulator/**'
      - '.github/workflows/simulator.yml'
    branches: [main] # é™å®š main åˆ†æ”¯

jobs:
  deploy-simulator:
    runs-on: ubuntu-latest # åœ¨ GitHub æä¾›çš„ Ubuntu runner ä¸ŠåŸ·è¡Œ

    steps:
      - name: Checkout source
        uses: actions/checkout@v4 # æŠŠ GitHub Repo çš„ç¨‹å¼ç¢¼æŠ“ä¸‹ä¾†åˆ° runner ä¸Š

      - name: Clean Docker Build Cache In Runner
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af
          docker builder prune -af
          echo "Docker resources cleaned."

      - name: Authenticate with Google Cloud # è¨­å®š GCP å°ˆæ¡ˆ IDï¼ˆä¾†è‡ª GitHub Secretï¼‰
        uses: google-github-actions/auth@v2 # ä½¿ç”¨ GCP æœå‹™å¸³è™Ÿé‡‘é‘°ç™»å…¥ï¼ˆJSONï¼‰
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Simulator Docker Image
        run: |
          echo "Deploying commit SHA: ${{ github.sha }}"
          IMAGE_TAG=${{ github.sha }}
          docker build \
            -t ${{ secrets.DOCKER_REGISTRY }}/acs-simulator:$IMAGE_TAG \
            -f ./simulator/Dockerfile \
            ./simulator
          docker push ${{ secrets.DOCKER_REGISTRY }}/acs-simulator:$IMAGE_TAG
          echo "ğŸ” Listing pushed image:"
          docker images | grep acs-simulator

      - name: SSH to VM via gcloud and deploy simulator
        env:
          VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
          IMAGE_TAG: ${{ github.sha }}
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_REDIS_HOST: ${{ secrets.SPRING_REDIS_HOST }}
          MQTT_BROKER: ${{ secrets.MQTT_BROKER }}
          MQTT_CLIENT_ID: ${{ secrets.MQTT_CLIENT_ID }}
          MQTT_USERNAME: ${{ secrets.MQTT_USERNAME }}
          MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
          MQTT_HOST: ${{ secrets.MQTT_HOST }}
          MQTT_PORT: ${{ secrets.MQTT_PORT }}
          TZ: ${{ secrets.TZ }}
        run: |
          echo "ğŸ” å°‡ç§é‘°å¯«å…¥ SSH é‡‘é‘°æª”"
          mkdir -p ~/.ssh
          echo "$VM_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          echo "ğŸ” åŠ å…¥ VM åˆ° known_hostsï¼ˆé¿å…é¦–æ¬¡é€£ç·šæç¤ºï¼‰"
          ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts

          echo "ğŸ§ª DOCKER_REGISTRY=$DOCKER_REGISTRY"
          echo "ğŸ§ª IMAGE_TAG=$IMAGE_TAG"
          echo "ğŸ§ª pull target = $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG"
          
          echo "ğŸ” é–‹å§‹ç™»å…¥ä¸¦åŸ·è¡Œéƒ¨ç½²è…³æœ¬"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << EOF
          
            set -e 

            echo 'ğŸ” [1/8] è¨­å®š IMAGE_TAGã€DOCKER_REGISTRY ç’°å¢ƒè®Šæ•¸'
            export IMAGE_TAG=$IMAGE_TAG
            export DOCKER_REGISTRY=$DOCKER_REGISTRY
          
            echo 'ğŸ” [2/8] ç¢ºèª Access-Control-System æ˜¯å¦å­˜åœ¨'
            if [ -d ~/Access-Control-System/.git ]; then
              echo 'ğŸ“¦ å·²å­˜åœ¨ Git å°ˆæ¡ˆï¼ŒåŸ·è¡Œ git pull'
              cd ~/Access-Control-System
              git pull origin main
            else
              echo 'ğŸ” [å‰ç½®] åŠ å…¥ GitHub åˆ° VM çš„ known_hostsï¼ˆé¿å… host key verification failedï¼‰'
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              echo 'ğŸ†• å°ˆæ¡ˆä¸å­˜åœ¨ï¼ŒåŸ·è¡Œ git clone'
              git clone git@github.com:Chiaching-Yeh/Access-Control-System.git ~/Access-Control-System
            fi

            echo 'ğŸ” [3/8] åˆ‡æ›è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ ~/Access-Control-System'
            cd ~/Access-Control-System && pwd && ls -la
          
            echo "ğŸ”‘ [4/8] ç”¢ç”Ÿ .env æª”æ¡ˆ"
            echo "POSTGRES_DB=$POSTGRES_DB" > .env
            echo "POSTGRES_USER=$POSTGRES_USER" >> .env
            echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
  
            echo "SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL" >> .env
            echo "SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD" >> .env
            echo "SPRING_REDIS_HOST=$SPRING_REDIS_HOST" >> .env
  
            echo "MQTT_BROKER=$MQTT_BROKER" >> .env
            echo "MQTT_CLIENT_ID=$MQTT_CLIENT_ID" >> .env
            echo "MQTT_USERNAME=$MQTT_USERNAME" >> .env
            echo "MQTT_PASSWORD=$MQTT_PASSWORD" >> .env
  
            echo "DOCKER_REGISTRY=$DOCKER_REGISTRY" >> .env
  
            echo "MQTT_HOST=$MQTT_HOST" >> .env
            echo "MQTT_PORT=$MQTT_PORT" >> .env
            echo "TZ=$TZ" >> .env
          
            echo 'ğŸ” [5/8] æª¢æŸ¥ infra container æ˜¯å¦å•Ÿå‹•'
            if [ -f /tmp/infra_ready ]; then
              echo 'âœ… å¿«å–å­˜åœ¨ï¼Œç•¥é Infra å•Ÿå‹•'
            else
              echo 'âš ï¸ æ‰¾ä¸åˆ°å¿«å–ï¼Œæª¢æŸ¥ container ç‹€æ…‹ä¸¦å¿…è¦æ™‚å•Ÿå‹• Infra'
              if [ "$(docker inspect -f '{{.State.Running}}' acs-db 2>/dev/null)" != "true" ] || \
                 [ "$(docker inspect -f '{{.State.Running}}' acs-redis 2>/dev/null)" != "true" ] || \
                 [ "$(docker inspect -f '{{.State.Running}}' acs-mqtt 2>/dev/null)" != "true" ]; then
                 echo 'ğŸ”§ æœ‰ infra container æœªåŸ·è¡Œï¼Œé‡æ–°å•Ÿå‹• Infra...'
                 docker compose -p access-control-system -f docker-compose-infra.yml up -d
                 echo "$(date)" > /tmp/infra_ready
              else
                 echo 'âœ… æ‰€æœ‰ Infra container æ­£å¸¸åŸ·è¡Œï¼Œæ›´æ–°å¿«å–æ™‚é–“æˆ³'
                 echo "$(date)" > /tmp/infra_ready
              fi
            fi
          
            echo "ğŸ” [6/8] å˜—è©¦æ‹‰å–æ˜ åƒ $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG"
            docker pull $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG
          
            echo "ğŸ” é©—è­‰æ˜ åƒå·²å­˜åœ¨æ–¼æœ¬åœ°"
            docker image inspect $DOCKER_REGISTRY/acs-simulator:$IMAGE_TAG >/dev/null && \
            echo "âœ… æ˜ åƒç¢ºèªæˆåŠŸå­˜åœ¨" || echo "âŒ æ‹‰å–å¤±æ•—"
          
            echo "ğŸ” [7/8] é¡å¤–å®‰å…¨é©—è­‰ ç¢ºèª .env èˆ‡å®¹å™¨ç’°å¢ƒè®Šæ•¸ä¸€è‡´"
            if grep -q "$POSTGRES_DB" .env && grep -q "$MQTT_CLIENT_ID" .env; then
              echo "âœ… .env ä¸­åŒ…å«æ©Ÿå¯†è®Šæ•¸ï¼Œæ‡‰ç‚ºéƒ¨ç½²æ™‚è‡ªå‹•ç”¢ç”Ÿ"
            else
              echo "âŒ .env å…§å®¹ç•°å¸¸ï¼Œæ©Ÿå¯†è®Šæ•¸ç¼ºå¤±ï¼Œè«‹ç¢ºèª CI/CD æ˜¯å¦æ³¨å…¥å¤±æ•—"
              exit 1
            fi
            if grep -i 'password' .env | grep -v '^#'; then
              echo "âš ï¸ .env ä¸­åŒ…å« password æ¬„ä½ï¼Œä½†å·²é™åˆ¶ä¸é¡¯ç¤ºåœ¨ log"
            fi

            echo 'ğŸ” [8/8] åŸ·è¡Œ docker compose up'
            docker compose -p access-control-system -f docker-compose-infra.yml -f docker-compose-app.yml up -d simulator
            echo 'âœ… éƒ¨ç½²å®Œæˆ'
          EOF