name: Deploy Frontend

on:
  workflow_dispatch:
  push:
    paths:
      - 'acs-frontend/**'
      - '.github/workflows/frontend.yml'
    branches: [main]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      # 執行清理所有未使用的 Docker 資源的命令。
      # 執行清理 BuildKit 構建快取的命令
      - name: Clean Docker Build Cache
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af
          docker builder prune -af  
          echo "Docker resources cleaned."

      - name: Debug - List current directory and check required files
        run: |
          echo "=== Current working directory ==="
          pwd
          echo "=== List all files in current directory ==="
          ls -la
          echo "=== List all files recursively ==="
          find . -type f -name "*.sh" -o -name "*.conf" -o -name "Dockerfile*" | head -20
          echo "=== Check for required files ==="
          echo "Checking for default.conf:"
          find . -name "default.conf" -type f || echo "❌ default.conf NOT FOUND"
          echo "=== Show dockerfile build context ==="
          ls -la ./acs-frontend/ || echo "acs-frontend directory not found"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker us-west1-docker.pkg.dev
        # 在 GitHub Actions 的 Runner 環境（Ubuntu VM）上執行的。
        # 這樣 runner 在 build image + docker push 到 GCP 時才會帶上 gcloud 身份認證。

      - name: Build and Push Frontend Docker Image
        run: |
          echo "Deploying commit SHA: ${{ github.sha }}"
          IMAGE_TAG=${{ github.sha }}
          docker build \
            --no-cache \
            -t ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG \
            -f ./acs-frontend/Dockerfile \
            ./acs-frontend
          docker push ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG

      - name: SSH and Deploy frontend on VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            export IMAGE_TAG=${{ github.sha }}
            echo "🔍 Deploying FrontEnd IMAGE_TAG: $IMAGE_TAG"
            
            echo "--- Configuring Docker Auth ---"
            gcloud auth configure-docker us-west1-docker.pkg.dev  
            echo "--- Docker Auth configured. ---"
            
            echo "--- Starting Docker Pull ---"
            docker pull ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG
            echo "--- Docker Pull completed. ---"
            
            echo "--- Tagging image ---"
            docker tag ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG acs-frontend:latest
            echo "--- Image tagged. ---"
            
            echo "--- Starting Docker Compose ---"
            docker-compose -f ~/Access-Control-System/docker-compose.yml up -d frontend
            echo "--- Docker Compose completed. ---"

          # 部署目標的 GCP VM 裡面執行的指令
          # 改寫 那台 VM 的 ~/.docker/config.json，讓 VM 上的 Docker pull 時知道用 gcloud 當認證工具
          # VM 執行 docker pull 時才能取得私有的 GCP Artifact Registry 映像