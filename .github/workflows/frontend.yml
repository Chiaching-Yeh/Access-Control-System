name: Deploy Frontend

on:
  workflow_dispatch:
  push:
    paths:
      - 'acs-frontend/**'
      - '.github/workflows/frontend.yml'
    branches: [main]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      # åŸ·è¡Œæ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„ Docker è³‡æºçš„å‘½ä»¤ã€‚
      # åŸ·è¡Œæ¸…ç† BuildKit æ§‹å»ºå¿«å–çš„å‘½ä»¤
      - name: Clean Docker Build Cache
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af
          docker builder prune -af  
          echo "Docker resources cleaned."

      - name: Debug - List current directory and check required files
        run: |
          echo "=== Current working directory ==="
          pwd
          echo "=== List all files in current directory ==="
          ls -la
          echo "=== List all files recursively ==="
          find . -type f -name "*.sh" -o -name "*.conf" -o -name "Dockerfile*" | head -20
          echo "=== Check for required files ==="
          echo "Checking for default.conf:"
          find . -name "default.conf" -type f || echo "âŒ default.conf NOT FOUND"
          echo "=== Show dockerfile build context ==="
          ls -la ./acs-frontend/ || echo "acs-frontend directory not found"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker us-west1-docker.pkg.dev
        # åœ¨ GitHub Actions çš„ Runner ç’°å¢ƒï¼ˆUbuntu VMï¼‰ä¸ŠåŸ·è¡Œçš„ã€‚
        # é€™æ¨£ runner åœ¨ build image + docker push åˆ° GCP æ™‚æ‰æœƒå¸¶ä¸Š gcloud èº«ä»½èªè­‰ã€‚

      - name: Build and Push Frontend Docker Image
        run: |
          echo "Deploying commit SHA: ${{ github.sha }}"
          IMAGE_TAG=${{ github.sha }}
          docker build \
            --no-cache \
            -t ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG \
            -f ./acs-frontend/Dockerfile \
            ./acs-frontend
          docker push ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG

      - name: SSH to VM via gcloud and deploy frontend
        run: |
            echo "ğŸ” Using gcloud compute ssh to login to VM"
            
            gcloud compute ssh ${{ secrets.VM_INSTANCE_NAME }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --zone=${{ secrets.VM_ZONE }} \
            --command="\
          
            echo 'ğŸ” [1/6] è¨­å®š IMAGE_TAG ç’°å¢ƒè®Šæ•¸' && \
            IMAGE_TAG=${{ github.sha }} && \
            echo 'âœ… IMAGE_TAG: \$IMAGE_TAG' && \
            
            echo 'ğŸ” [2/6] åˆ‡æ›è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ ~/Access-Control-System' && \
            cd ~/Access-Control-System && pwd && ls -la && \
            
            echo 'ğŸ” [3/6] Docker pull æœ€æ–°æ˜ åƒ' && \
            docker pull ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:\$IMAGE_TAG && \
            
            echo 'ğŸ” [4/6] Tag æˆ acs-frontend:latestï¼ˆä¾› compose ä½¿ç”¨ï¼‰' && \
            docker tag ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:\$IMAGE_TAG acs-frontend:latest && \
            
            echo 'ğŸ” [5/6] æª¢æŸ¥ docker-compose.yml æ˜¯å¦å­˜åœ¨' && \
            ls -l docker-compose.yml || echo 'âŒ æ‰¾ä¸åˆ° docker-compose.yml' && \
            
            echo 'ğŸ” [6/6] åŸ·è¡Œ docker-compose up -d frontend' && \
            docker-compose -f docker-compose.yml up -d frontend && \
            
            echo 'âœ… éƒ¨ç½²å®Œæˆ'
            "
    

    #      - name: SSH and Deploy frontend on VM
#        uses: appleboy/ssh-action@v1
#        with:
#          host: ${{ secrets.VM_HOST }}
#          username: ${{ secrets.VM_USER }}
#          key: ${{ secrets.VM_SSH_KEY }}
#          script: |
#            export IMAGE_TAG=${{ github.sha }}
#            echo "ğŸ” Deploying FrontEnd IMAGE_TAG: $IMAGE_TAG"
#
#            echo "--- Configuring Docker Auth ---"
#            gcloud auth configure-docker us-west1-docker.pkg.dev
#            echo "--- Docker Auth configured. ---"
#
#            echo "--- Starting Docker Pull ---"
#            docker pull ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG
#            echo "--- Docker Pull completed. ---"
#
#            echo "--- Tagging image ---"
#            docker tag ${{ secrets.DOCKER_REGISTRY }}/acs-frontend:$IMAGE_TAG acs-frontend:latest
#            echo "--- Image tagged. ---"
#
#            echo "--- Starting Docker Compose ---"
#            docker-compose -f ~/Access-Control-System/docker-compose.yml up -d frontend
#            echo "--- Docker Compose completed. ---"



          # éƒ¨ç½²ç›®æ¨™çš„ GCP VM è£¡é¢åŸ·è¡Œçš„æŒ‡ä»¤
          # æ”¹å¯« é‚£å° VM çš„ ~/.docker/config.jsonï¼Œè®“ VM ä¸Šçš„ Docker pull æ™‚çŸ¥é“ç”¨ gcloud ç•¶èªè­‰å·¥å…·
          # VM åŸ·è¡Œ docker pull æ™‚æ‰èƒ½å–å¾—ç§æœ‰çš„ GCP Artifact Registry æ˜ åƒ