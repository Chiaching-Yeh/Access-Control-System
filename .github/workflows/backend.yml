name: Deploy Backend

on:
  workflow_dispatch:
  push:
    paths:
      - 'acs-backend/**'  # åªè¦ backend è³‡æ–™å¤¾æœ‰è®Šæ›´ï¼Œå°±è§¸ç™¼é€™å€‹ workflow #test
      - '.github/workflows/backend.yml'   # æˆ–è€…é€™å€‹ workflow æª”æ¡ˆæœ¬èº«æœ‰è®Šæ›´
    branches: [main] # é™å®š main åˆ†æ”¯

jobs:
  deploy-backend:
    runs-on: ubuntu-latest # åœ¨ GitHub æä¾›çš„ Ubuntu runner ä¸ŠåŸ·è¡Œ

    steps:
      - name: Checkout source
        uses: actions/checkout@v3 # æŠŠ GitHub Repo çš„ç¨‹å¼ç¢¼æŠ“ä¸‹ä¾†åˆ° runner ä¸Š

      - name: Authenticate with Google Cloud # è¨­å®š GCP å°ˆæ¡ˆ IDï¼ˆä¾†è‡ª GitHub Secretï¼‰
        uses: google-github-actions/auth@v1 # ä½¿ç”¨ GCP æœå‹™å¸³è™Ÿé‡‘é‘°ç™»å…¥ï¼ˆJSONï¼‰
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker us-west1-docker.pkg.dev # è¨­å®š Docker å¯ä»¥ç™»å…¥ GCP çš„ Artifact Registryï¼Œç”¨ä¾†æ¨é€ image

      - name: Build and Push Backend Docker Image  # ä½¿ç”¨ backend çš„ Dockerfile æ‰“åŒ… imageï¼Œtag æˆ artifact registry æ ¼å¼ï¼Œæ¨é€åˆ° Artifact Registryï¼Œçµ¦ VM æ‹‰å–ç”¨
        run: |
          echo "Deploying commit SHA: ${{ github.sha }}"
          IMAGE_TAG=${{ github.sha }}
          docker build --no-cache -t ${{ secrets.DOCKER_REGISTRY }}/acs-backend:$IMAGE_TAG -f ./acs-backend/Dockerfile .
          docker push ${{ secrets.DOCKER_REGISTRY }}/acs-backend:$IMAGE_TAG

      ## é€™è£¡è‹¥æ²’æœ‰åŠ  -f æŒ‡å®š Dockerfile çš„ä½ç½®ï¼Œè€Œæ˜¯å–®ç´”æŠŠ ./acs-backend ç•¶ä½œ build contextã€‚
      # å®ƒæœƒé è¨­åœ¨ä½ æŒ‡å®šçš„ç›®éŒ„ (./acs-backend) è£¡æ‰¾ Dockerfileã€‚
      # å®ƒæœƒæŠŠ ./acs-backend è¨­ç‚º build contextï¼ˆå°±æ˜¯ COPY æŒ‡ä»¤çš„æ ¹ç›®éŒ„ï¼‰ã€‚
      # æ›å¥è©±èªªï¼šé€™æœƒè®“ Docker æ ¹æœ¬çœ‹ä¸åˆ°æ ¹ç›®éŒ„çš„ acs-common/ã€pom.xml ç­‰æª”æ¡ˆã€‚

      - name: SSH and Deploy Backend on VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}   # GCP VM çš„å¤–éƒ¨ IP
          username: ${{ secrets.VM_USER }}  # ç™»å…¥ä½¿ç”¨è€…å¸³è™Ÿ
          key: ${{ secrets.VM_SSH_KEY }}  # å°æ‡‰çš„ SSH ç§é‘°ï¼ˆè²¼åœ¨ GitHub Secretï¼‰
          # å¾ Artifact Registry æ‹‰ä¸‹æœ€æ–° backend imageï¼Œ # ä½¿ç”¨ docker-compose é‡æ–°å•Ÿå‹• backend æœå‹™ï¼ˆåªæ›´æ–° backendï¼Œä¸å‹•å…¶ä»–ï¼‰
          script: |
            export IMAGE_TAG=${{ github.sha }}
            echo "ğŸ” Deploying BackEnd IMAGE_TAG: $IMAGE_TAG"
            gcloud auth configure-docker us-west1-docker.pkg.dev
            docker pull ${{ secrets.DOCKER_REGISTRY }}/acs-backend:$IMAGE_TAG
            docker tag ${{ secrets.DOCKER_REGISTRY }}/acs-backend:$IMAGE_TAG acs-backend:latest
            docker-compose -f ~/Access-Control-System/docker-compose.yml up -d backend