# ç¬¬ 1 éšæ®µï¼ˆbuildï¼‰
# ç”¨ Node.js ç·¨è­¯ Angular å°ˆæ¡ˆï¼Œç”¢å‡º dist éœæ…‹æª”

FROM node:18-alpine AS build
# ä½¿ç”¨ Node.js 18 + Alpine ç‰ˆç•¶ä½œå»ºæ§‹éšæ®µï¼ˆbuild stageï¼‰çš„ base image
# alpine è¡¨ç¤ºç²¾ç°¡ã€é«˜æ•ˆã€å°é«”ç©
# AS build æ˜¯çµ¦é€™å€‹éšæ®µå‘½åï¼Œå¾Œé¢æœƒç”¨ --from=build ä¾†å¼•ç”¨

WORKDIR /usr/src/app
# è¨­å®š container å…§çš„å·¥ä½œç›®éŒ„ç‚º /usr/src/app
# ä¹‹å¾Œçš„æ‰€æœ‰ COPY, RUN æŒ‡ä»¤éƒ½æœƒä»¥é€™å€‹ç›®éŒ„ç‚ºåŸºæº–

# å®‰è£å¿…è¦å¥—ä»¶ï¼ˆç¢ºä¿ ng CLI å¯åŸ·è¡Œæ™‚ä¸æœƒç¼º native ç·¨è­¯å…ƒä»¶ï¼‰
RUN apk add --no-cache bash

# å…ˆè¤‡è£½ package.json å’Œ package-lock.jsonï¼ˆåˆ©ç”¨ Docker layer cache å„ªåŒ–ï¼‰ï¼Œé€™æ¨£å¦‚æœç¨‹å¼ç¢¼è®Šæ›´ä½†å¥—ä»¶æ²’è®Šï¼Œå°±ä¸éœ€è¦é‡æ–°å®‰è£å¥—ä»¶ã€‚
COPY ./acs-frontend/package*.json ./

# å®‰è£ç›¸ä¾å¥—ä»¶
RUN npm install

# è¤‡è£½ acs-frontend ç›®éŒ„çš„æ‰€æœ‰æª”æ¡ˆåˆ°å®¹å™¨å…§çš„å·¥ä½œç›®éŒ„
COPY ./acs-frontend/ .

ARG BUILD_ENV=production
# å¦‚æœæ²’æœ‰åœ¨docker run æŒ‡ä»¤ä¸­æä¾› --build-arg BUILD_ENV=xxxï¼Œå°±é è¨­ç”¨ production
# å¦‚æœä½ æœ‰æä¾›ï¼Œæœƒè¦†è“‹å®ƒ

ENV PATH="/usr/src/app/node_modules/.bin:$PATH"
RUN chmod +x ./node_modules/.bin/ng \
    && echo "âœ… Angular CLI path: $(which ng)" \
# åŠ å…¥å…¨åŸŸ CLI è·¯å¾‘èˆ‡æ¬Šé™ä¿®å¾©ï¼ˆå¹« ng æŒ‡ä»¤æª”æ¡ˆåŠ ä¸ŠåŸ·è¡Œæ¬Šé™ï¼Œè®“ shell èƒ½åŸ·è¡Œå®ƒï¼‰
# åŠ å…¥ ng è·¯å¾‘ï¼Œé¿å…å›  Alpine çš„ç²¾ç°¡ç‰ˆ Linux é è¨­ node_modules/.bin ä¸åœ¨ PATH ä¸­ï¼Œå°è‡´ ng ç„¡æ³•è¢« shell æ‰¾åˆ°æˆ–åŸ·è¡Œã€‚

RUN echo "ğŸ›  Building Angular app with configuration: $BUILD_ENV"
# é¡¯ç¤ºç·¨è­¯ç’°å¢ƒè³‡è¨Š

RUN npm run build -- --configuration=$BUILD_ENV
# åœ¨ container è£¡åŸ·è¡Œï¼š
# npm installï¼šå®‰è£ Angular å°ˆæ¡ˆæ‰€éœ€çš„ç›¸ä¾å¥—ä»¶
# npm run buildï¼šåŸ·è¡Œ buildï¼Œæœƒç”¢å‡ºåœ¨ dist/<project-name>/

# ç¬¬ 2 éšæ®µ
# ç”¨ Nginx æä¾›éœæ…‹æª”æœå‹™
FROM nginx:stable-alpine
# å»ºç«‹æ–°çš„éšæ®µï¼ˆrun stageï¼‰ï¼Œä»¥å®˜æ–¹çš„ Nginx + Alpine ç‰ˆä½œç‚º base image
# ç”¨ä¾† serve å‰ç«¯çš„éœæ…‹æª”æ¡ˆï¼ˆ.html, .js, .cssï¼‰
# Nginx æ˜¯æœ€ç©©å®šã€æ•ˆèƒ½æœ€ä½³çš„éœæ…‹ä¼ºæœå™¨ä¹‹ä¸€

ARG BUILD_ENV=production


COPY --from=build /usr/src/app/dist/acs-frontend /usr/share/nginx/html
# è¤‡è£½ Angular éœæ…‹æª”è‡³ nginx å°æ‡‰ç›®éŒ„
# å¾å‰ä¸€å€‹ build éšæ®µä¸­ï¼ŒæŠŠ dist/ ä¸­ç·¨è­¯å¥½çš„ Angular éœæ…‹æª”è¤‡è£½é€² nginx çš„å°å¤–æ ¹ç›®éŒ„ /usr/share/nginx/html

# æ ¹æ“šä¸åŒç’°å¢ƒæ³¨å…¥æ­£ç¢ºçš„ env.template.js
COPY ./acs-frontend/src/assets/env.${BUILD_ENV}.template.js /usr/share/nginx/html/assets/env.template.js

# è¤‡è£½è‡ªè¨‚ Nginx è¨­å®šèˆ‡å•Ÿå‹•è…³æœ¬
COPY ./acs-frontend/default.conf /etc/nginx/conf.d/default.conf

# è¤‡è£½ docker-entrypoint.sh è…³æœ¬
COPY ./acs-frontend/docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

EXPOSE 80
# å®£å‘Š container å°å¤–æä¾›æœå‹™çš„ port æ˜¯ 80ï¼ˆNginx é è¨­ portï¼‰

# å®¹å™¨å•Ÿå‹•æ™‚æœƒè‡ªå‹•ç”¢å‡º env.jsï¼Œä¾› index.html è¼‰å…¥
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
