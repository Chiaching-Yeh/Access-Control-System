# ç¬¬ 1 éšæ®µï¼ˆbuildï¼‰
# ç”¨ Node.js ç·¨è­¯ Angular å°ˆæ¡ˆï¼Œç”¢å‡º dist éœæ…‹æª”

FROM node:18-alpine AS build
# ä½¿ç”¨ Node.js 18 + Alpine ç‰ˆç•¶ä½œå»ºæ§‹éšæ®µï¼ˆbuild stageï¼‰çš„ base image
# alpine è¡¨ç¤ºç²¾ç°¡ã€é«˜æ•ˆã€å°é«”ç©
# AS build æ˜¯çµ¦é€™å€‹éšæ®µå‘½åï¼Œå¾Œé¢æœƒç”¨ --from=build ä¾†å¼•ç”¨

WORKDIR /usr/src/app
# è¨­å®š container å…§çš„å·¥ä½œç›®éŒ„ç‚º /usr/src/app
# ä¹‹å¾Œçš„æ‰€æœ‰ COPY, RUN æŒ‡ä»¤éƒ½æœƒä»¥é€™å€‹ç›®éŒ„ç‚ºåŸºæº–

# Debug 1ï¼šæª¢æŸ¥ build context æ˜¯å¦æ­£ç¢º
RUN echo "ğŸ Build Context æ ¹ç›®éŒ„å…§å®¹ï¼š" && ls -al && echo "==="

# å®‰è£å¿…è¦å¥—ä»¶ï¼ˆç¢ºä¿ ng CLI å¯åŸ·è¡Œæ™‚ä¸æœƒç¼º native ç·¨è­¯å…ƒä»¶ï¼‰
RUN apk add --no-cache bash

ARG BUILD_ENV=production
ARG API_URL=https://35.212.237.104:8080
# å¦‚æœæ²’æœ‰åœ¨docker run æŒ‡ä»¤ä¸­æä¾› --build-arg BUILD_ENV=xxxï¼Œå°±é è¨­ç”¨ production
# å¦‚æœä½ æœ‰æä¾›ï¼Œæœƒè¦†è“‹å®ƒ

# å…ˆå®‰è£ Angular CLIï¼Œç¢ºä¿ `ng` å¯åŸ·è¡Œï¼ˆé¿å… `sh: ng: Permission denied`ï¼‰
RUN npm install -g @angular/cli

# ğŸ§ª ç¢ºèª ng CLI å®‰è£æˆåŠŸä¸”å…·æœ‰åŸ·è¡Œæ¬Šé™
RUN echo "âœ… global ng path: $(which ng)" && ls -l $(which ng)

# å…ˆè¤‡è£½ package.json å’Œ package-lock.jsonï¼ˆåˆ©ç”¨ Docker layer cache å„ªåŒ–ï¼‰ï¼Œé€™æ¨£å¦‚æœç¨‹å¼ç¢¼è®Šæ›´ä½†å¥—ä»¶æ²’è®Šï¼Œå°±ä¸éœ€è¦é‡æ–°å®‰è£å¥—ä»¶ã€‚
COPY package*.json ./

# å®‰è£ç›¸ä¾å¥—ä»¶
RUN npm install

# Debug 3ï¼šå®‰è£å®Œå¾Œç¢ºèª ng CLI è·¯å¾‘èˆ‡æ¬Šé™
RUN echo "ğŸ“¦ BEFORE COPY . ." && ls -l $(which ng)

# è¤‡è£½ acs-frontend ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆåˆ°å®¹å™¨å…§çš„å·¥ä½œç›®éŒ„ COPY <ä¾†æºè·¯å¾‘> <ç›®çš„åœ°è·¯å¾‘>
COPY . .

RUN chmod +x ./node_modules/.bin/ng
RUN chmod +x /usr/local/bin/ng

# âœ… å†æ¬¡ç¢ºèª ng CLI ä»ç„¶æ˜¯ global å®‰è£çš„ç‰ˆæœ¬
RUN echo "ğŸ“¦ ng ç¢ºèªï¼š" && which ng && ls -l $(which ng)

# Debug 4ï¼šCOPY å¾Œå†æ¬¡ç¢ºèª ng CLI æœ‰æ²’æœ‰è¢«è¦†è“‹æ‰
RUN echo "ğŸ“¦ AFTER COPY . ." && ls -l $(which ng)

# ç¢ºä¿ `ng` æŒ‡ä»¤æ“æœ‰åŸ·è¡Œæ¬Šé™
RUN echo "âœ… Angular CLI path: $(which ng)"

# é¡¯ç¤ºç·¨è­¯ç’°å¢ƒè³‡è¨Š
RUN echo "ğŸ›  Building Angular app with configuration: $BUILD_ENV"

# ç¦ç”¨ Angular CLI å¿«å–ï¼Œç¢ºä¿ `ng build` ç¸½æ˜¯é‡æ–°ç·¨è­¯
RUN ng config cli.cache.enabled false
RUN rm -rf .angular/cache

# Debug 6ï¼šåˆ—å‡º src èˆ‡ assetsï¼Œç¢ºä¿å­˜åœ¨
RUN echo "ğŸ“ ç¢ºèª src/ assets/ å­˜åœ¨ï¼Ÿ" && ls -al src && ls -al src/assets || echo "âŒ æ‰¾ä¸åˆ°"

# åŸ·è¡Œ Angular build
RUN npm run build -- --configuration=$BUILD_ENV

# mkdir -p æœƒç¢ºä¿ assets/ ç›®éŒ„å­˜åœ¨ï¼Œé¿å… sed å¤±æ•—
# åœ¨ build éšæ®µå®Œæˆç’°å¢ƒè®Šæ•¸æ³¨å…¥ï¼ˆæ¸›å°‘ runtime è®Šæ•¸éŒ¯èª¤ï¼‰
RUN mkdir -p ./dist/acs-frontend/assets && \
    sed "s|__API_URL__|${API_URL}|g" ./src/assets/env.${BUILD_ENV}.template.js > ./dist/acs-frontend/assets/env.js

# ç¬¬ 2 éšæ®µ
# ç”¨ Nginx æä¾›éœæ…‹æª”æœå‹™
FROM nginx:stable-alpine
# å»ºç«‹æ–°çš„éšæ®µï¼ˆrun stageï¼‰ï¼Œä»¥å®˜æ–¹çš„ Nginx + Alpine ç‰ˆä½œç‚º base image
# ç”¨ä¾† serve å‰ç«¯çš„éœæ…‹æª”æ¡ˆï¼ˆ.html, .js, .cssï¼‰
# Nginx æ˜¯æœ€ç©©å®šã€æ•ˆèƒ½æœ€ä½³çš„éœæ…‹ä¼ºæœå™¨ä¹‹ä¸€

COPY --from=build /usr/src/app/dist/acs-frontend /usr/share/nginx/html
# è¤‡è£½ Angular éœæ…‹æª”è‡³ nginx å°æ‡‰ç›®éŒ„
# å¾å‰ä¸€å€‹ build éšæ®µä¸­ï¼ŒæŠŠ dist/ ä¸­ç·¨è­¯å¥½çš„ Angular éœæ…‹æª”è¤‡è£½é€² nginx çš„å°å¤–æ ¹ç›®éŒ„ /usr/share/nginx/html

# è¤‡è£½è‡ªè¨‚ Nginx è¨­å®šèˆ‡å•Ÿå‹•è…³æœ¬
#COPY ./acs-frontend/default.conf /etc/nginx/conf.d/default.conf
COPY default.conf /etc/nginx/conf.d/default.conf


EXPOSE 80
# å®£å‘Š container å°å¤–æä¾›æœå‹™çš„ port æ˜¯ 80ï¼ˆNginx é è¨­ portï¼‰

CMD ["nginx", "-g", "daemon off;"]
