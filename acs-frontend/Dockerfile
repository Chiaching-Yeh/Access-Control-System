# -------- ç¬¬ä¸€éšæ®µï¼šBuild Angular --------
FROM node:22-alpine AS build

WORKDIR /usr/src/app
# å®‰è£å¿…è¦å·¥å…·
RUN apk add --no-cache bash

COPY package*.json ./

# å®‰è£ç›¸ä¾å¥—ä»¶
RUN npm install

# è¤‡è£½å°ˆæ¡ˆåŸå§‹ç¢¼ï¼ˆæ’é™¤ .dockerignore çš„é …ç›®ï¼‰
COPY . .

# é¿å… Permission denied èˆ‡ Angular cache
RUN npx ng config cli.cache.enabled false && rm -rf .angular/cache

# åŸ·è¡Œç·¨è­¯
ARG BUILD_ENV=production
ARG API_URL=https://charlielab.online/api
RUN npx ng build --configuration=$BUILD_ENV

# âœ… Debugï¼šåˆ—å‡º dist çµæœ
RUN echo "ğŸ“ æª¢æŸ¥ SSR build è¼¸å‡ºç›®éŒ„ï¼š" && \
    ls -al ./dist/acs-frontend/browser


# âœ… Debugï¼šè‹¥æœ‰ index.csr.html å°±æ”¹åç‚º index.htmlï¼Œå¦å‰‡æç¤ºè·³é
RUN if [ -f ./dist/acs-frontend/browser/index.csr.html ]; then \
      echo "âœ… index.csr.html æ‰¾åˆ°äº†ï¼Œæ”¹åæˆ index.html"; \
      mv ./dist/acs-frontend/browser/index.csr.html ./dist/acs-frontend/browser/index.html; \
    else \
      echo "âš ï¸  index.csr.html ä¸å­˜åœ¨ï¼Œç•¥é rename"; \
    fi

RUN cat ./dist/acs-frontend/browser/index.html

# âœ… Debugï¼šåˆ—å‡º index.html æœ€çµ‚ç¢ºèª
RUN echo "ğŸ“„ index.html æœ€çµ‚ç‹€æ…‹ï¼š" && ls -l ./dist/acs-frontend/browser/index.html || echo "â›” index.html ä¸å­˜åœ¨ï¼"

# ç”¢ç”Ÿç’°å¢ƒè®Šæ•¸æª”ï¼ˆä¾› Angular ä½¿ç”¨ï¼‰
RUN mkdir -p ./dist/acs-frontend/browser/assets && \
    sed "s|__API_URL__|${API_URL}|g" ./src/assets/env.${BUILD_ENV}.template.js > ./dist/acs-frontend/browser/assets/env.js

# âœ… Debugï¼šé å…ˆæ¨¡æ“¬ nginx volume æ›è¼‰æ™‚æœƒçœ‹åˆ°ä»€éº¼
RUN echo "ğŸ“¦ æ¨¡æ“¬ nginx æ›è¼‰æ™‚çœ‹åˆ°çš„ç›®éŒ„çµæ§‹ï¼š" && \
    ls -al ./dist/acs-frontend/browser


# -------- ç¬¬äºŒéšæ®µï¼šServe with Nginx --------
#FROM nginx:stable-alpine
#
##  è¤‡è£½ Angular ç·¨è­¯çµæœåˆ° Nginx éœæ…‹ç¶²ç«™æ ¹ç›®éŒ„
#COPY --from=build /usr/src/app/dist/acs-frontend/browser /usr/share/nginx/html
#
## æŠŠ index.csr.html æ”¹åæˆ index.htmlï¼ˆè¦†è“‹æ‰é è¨­é é¢ï¼‰
#RUN mv /usr/share/nginx/html/index.csr.html /usr/share/nginx/html/index.html
#
## è¤‡è£½ Nginx è‡ªè¨‚è¨­å®š
#COPY default.conf /etc/nginx/conf.d/default.conf
#
#EXPOSE 80
#
#CMD ["nginx", "-g", "daemon off;"]
