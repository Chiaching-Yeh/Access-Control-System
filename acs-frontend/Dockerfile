# -------- ç¬¬ä¸€éšæ®µï¼šBuild Angular --------
FROM node:22-alpine AS build

WORKDIR /usr/src/app

RUN echo "ğŸ“¦ build context æª”æ¡ˆï¼š" && find . -maxdepth 2

# å®‰è£å¿…è¦å·¥å…·
RUN apk add --no-cache bash

RUN echo "ğŸ“¦ build context æª”æ¡ˆ2ï¼š" && find . -maxdepth 2

COPY package*.json ./

RUN echo "ğŸ“¦ build context æª”æ¡ˆ3ï¼š" && find . -maxdepth 2
# å®‰è£ç›¸ä¾å¥—ä»¶
RUN npm install

RUN echo "ğŸ“¦ build context æª”æ¡ˆ4ï¼š" && find . -maxdepth 2

# è¤‡è£½å°ˆæ¡ˆåŸå§‹ç¢¼ï¼ˆæ’é™¤ .dockerignore çš„é …ç›®ï¼‰
COPY . .

# é¿å… Permission denied èˆ‡ Angular cache
RUN chmod +x ./node_modules/.bin/ng && \
    npx ng config cli.cache.enabled false && \
    rm -rf .angular/cache

# åŸ·è¡Œç·¨è­¯
ARG BUILD_ENV=production
ARG API_URL=https://35.212.237.104:8080
RUN npx ng build --configuration=$BUILD_ENV --verbose

# ç”¢ç”Ÿç’°å¢ƒè®Šæ•¸æª”ï¼ˆä¾› Angular ä½¿ç”¨ï¼‰
RUN mkdir -p ./dist/acs-frontend/assets && \
    sed "s|__API_URL__|${API_URL}|g" ./src/assets/env.${BUILD_ENV}.template.js > ./dist/acs-frontend/assets/env.js

# æ¸…é™¤ä¸å¿…è¦æª”æ¡ˆä»¥æ¸›å°‘ image é«”ç©
RUN rm -rf node_modules \
           src \
           e2e \
           .git \
           .angular \
           .vscode \
           .npm \
           README.md \
           package-lock.json

# -------- ç¬¬äºŒéšæ®µï¼šServe with Nginx --------
FROM nginx:stable-alpine

# è¤‡è£½ç·¨è­¯å¾Œçš„æª”æ¡ˆåˆ° Nginx å°å¤–ç›®éŒ„
COPY --from=build /usr/src/app/dist/acs-frontend /usr/share/nginx/html

# è¤‡è£½ Nginx è‡ªè¨‚è¨­å®š
COPY default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
